<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RealmChat | Universe</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- STYLES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { display: flex; height: 100vh; background-color: #36393f; color: white; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        
        /* Layout */
        .server-bar { width: 72px; background-color: #202225; display: flex; flex-direction: column; align-items: center; padding-top: 12px; flex-shrink: 0; }
        .server-icon { width: 48px; height: 48px; background-color: #36393f; border-radius: 50%; margin-bottom: 10px; cursor: pointer; background-size: cover; position: relative; transition: 0.2s; }
        .server-icon:hover { border-radius: 15px; background-color: #5865F2; }
        
        .sidebar { width: 240px; background-color: #2f3136; display: flex; flex-direction: column; flex-shrink: 0; }
        .server-header { height: 48px; padding: 12px 16px; font-weight: bold; box-shadow: 0 1px 0 rgba(4,4,5,0.2); display: flex; align-items: center; justify-content: space-between; }
        .channel-list { padding: 10px; flex: 1; overflow-y: auto; }
        .channel { padding: 6px 8px; margin-bottom: 2px; border-radius: 4px; color: #8e9297; cursor: pointer; display: flex; align-items: center; }
        .channel:hover { background-color: #34373c; color: #dcddde; }
        .channel.active { background-color: #393c43; color: white; }
        
        .chat-area { flex: 1; background-color: #36393f; display: flex; flex-direction: column; min-width: 0; }
        .chat-header { height: 48px; padding: 0 16px; display: flex; align-items: center; box-shadow: 0 1px 0 rgba(4,4,5,0.2); font-weight: bold; justify-content: space-between;}
        
        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .message { display: flex; gap: 16px; padding: 5px 0; position: relative; }
        .message:hover { background-color: #32353b; }
        
        .message-actions { position: absolute; right: 10px; top: -10px; background-color: #36393f; border: 1px solid #202225; border-radius: 4px; padding: 2px; display: none; }
        .message:hover .message-actions { display: flex; }
        .action-btn { padding: 5px 8px; cursor: pointer; color: #b9bbbe; }
        .action-btn:hover { color: white; background-color: #40444b; }
        .action-btn.delete:hover { color: #ed4245; }

        .avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #5865F2; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .message-content h4 { font-size: 16px; margin-bottom: 4px; color: white; font-weight: 500; }
        
        /* Badges */
        .badge { font-size: 10px; padding: 2px 4px; border-radius: 3px; vertical-align: middle; margin-left: 5px; }
        .badge-admin { background-color: #ed4245; color: white; }
        .badge-mod { background-color: #faa61a; color: black; }

        .input-area { padding: 0 16px 24px; background-color: #36393f; margin-top: auto; }
        .input-box { background-color: #40444b; border-radius: 8px; padding: 11px 16px; color: white; display: flex; align-items: center; }
        input { background: transparent; border: none; color: white; width: 100%; outline: none; }

        /* Stats & Modal */
        .stats-box { font-size: 12px; color: #b9bbbe; padding: 10px; border-top: 1px solid #202225; }
        
        #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content { background-color: #36393f; padding: 30px; border-radius: 8px; width: 400px; text-align: center; }
        .btn-save { background-color: #3ba55c; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 15px; }

    </style>
</head>
<body>

    <div id="settings-modal">
        <div class="modal-content">
            <h2>User Profile</h2>
            <p style="color: #b9bbbe; margin: 10px 0;">Customize how you appear to others.</p>
            <input type="text" id="new-username" placeholder="Enter new display name" style="width: 100%; padding: 10px; background: #202225; border: none; color: white;">
            <button class="btn-save" onclick="saveProfile()">Save Changes</button>
            <button onclick="closeSettings()" style="background: transparent; border: none; color: #ed4245; margin-top: 10px; cursor: pointer;">Cancel</button>
        </div>
    </div>

    <div class="server-bar">
        <a href="index.html" class="server-icon" style="background-image: url('https://i.ibb.co/vC1NGG8R/fedora-realmos-start-logo.png');"></a>
    </div>

    <div class="sidebar">
        <div class="server-header">RealmOS <span id="admin-indicator" style="display:none; color: #ed4245; font-size: 10px; margin-left: 5px;">ADMIN MODE</span></div>
        <div class="channel-list">
            <div class="channel active"><span style="margin-right:5px">#</span> general</div>
            <div class="channel"><span style="margin-right:5px">#</span> development</div>
            <div class="channel"><span style="margin-right:5px">#</span> realm-submissions</div>
        </div>
        
        <div class="stats-box">
            <div id="member-count">üü¢ Loading Members...</div>
        </div>

        <div style="background-color: #292b2f; padding: 8px; display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <div class="avatar" style="width: 32px; height: 32px; font-size: 12px;">U</div>
                <div><div style="font-size: 13px; font-weight: bold;" id="my-username">Loading...</div></div>
            </div>
            <div style="color: #b9bbbe; cursor: pointer;" onclick="openSettings()">‚öôÔ∏è</div>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <span style="font-size: 24px; margin-right: 10px; color: #72767d;">#</span>
            <span id="current-channel-name">general</span>
        </div>
        <div class="messages" id="message-container"></div>
        <div class="input-area">
            <div class="input-box">
                <input type="text" id="chat-input" placeholder="Message #general" autocomplete="off">
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://vmrqbonwwnpjibynevpr.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_BCCcap8OUfF3SwGxOnkVCQ_FFWeWeDR';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // State
        let currentUser = null;
        let userProfile = null;
        let currentChannel = 'general';
        const ADMIN_EMAIL = 'realmos.official@outlook.com';

        // DOM
        const container = document.getElementById('message-container');
        const input = document.getElementById('chat-input');
        
        // --- 1. AUTH & PROFILES ---
        async function checkUser() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) { window.location.href = "login.html"; return; }
            currentUser = user;

            // 1. Get or Create Profile
            let { data: profile } = await _supabase.from('profiles').select('*').eq('id', user.id).single();
            
            if (!profile) {
                // First time user? Create profile
                const username = user.user_metadata.display_name || user.email.split('@')[0];
                const { data: newProfile } = await _supabase.from('profiles').insert([{
                    id: user.id,
                    email: user.email,
                    username: username,
                    role: (user.email === ADMIN_EMAIL) ? 'admin' : 'member'
                }]).select().single();
                userProfile = newProfile;
            } else {
                userProfile = profile;
            }

            // 2. Check Ban Status
            if (userProfile && userProfile.is_banned) {
                document.body.innerHTML = `<h1 style="color:red; text-align:center; margin-top:50px;">üö´ YOU HAVE BEEN BANNED FROM THE REALM.</h1>`;
                return;
            }

            // 3. UI Updates
            document.getElementById('my-username').innerText = userProfile.username;
            if (user.email === ADMIN_EMAIL) {
                document.getElementById('admin-indicator').style.display = 'inline';
            }

            // 4. Update Member Count
            updateMemberCount();
            
            // 5. Load Chat
            fetchMessages(currentChannel);
        }
        checkUser();

        async function updateMemberCount() {
            const { count } = await _supabase.from('profiles').select('*', { count: 'exact', head: true });
            document.getElementById('member-count').innerText = `üü¢ ${count || 1} Members Registered`;
        }

        // --- 2. SETTINGS LOGIC ---
        function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
        
        async function saveProfile() {
            const newName = document.getElementById('new-username').value;
            if(!newName) return;

            // Update Auth Meta (Standard)
            await _supabase.auth.updateUser({ data: { display_name: newName } });
            
            // Update Profile Table (For Bans/Roles)
            await _supabase.from('profiles').update({ username: newName }).eq('id', currentUser.id);

            document.getElementById('my-username').innerText = newName;
            userProfile.username = newName; // Update local state
            closeSettings();
            alert("Name updated!");
        }

        // --- 3. FETCH MESSAGES ---
        async function fetchMessages(channelName) {
            container.innerHTML = `<div style="padding: 20px;">Loading...</div>`;
            let { data: messages, error } = await _supabase
                .from('messages')
                .select('*')
                .eq('channel', channelName)
                .order('created_at', { ascending: true });

            container.innerHTML = "";
            if(messages) messages.forEach(renderMessage);
        }

        // --- 4. RENDER MESSAGE ---
        function renderMessage(msg) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message';
            msgDiv.id = `msg-${msg.id}`;

            const time = new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Badges
            let badgeHtml = '';
            if (msg.username.toLowerCase().includes('realmos') || msg.username.toLowerCase().includes('admin')) {
                badgeHtml = `<span class="badge badge-admin">ADMIN</span>`;
            }

            // Delete Button (Check User ID)
            let deleteBtn = '';
            // Allow deletion if: I own the message OR I am the Admin
            if ((currentUser && msg.user_id === currentUser.id) || (currentUser.email === ADMIN_EMAIL)) {
                deleteBtn = `<div class="action-btn delete" onclick="deleteMessage('${msg.id}')" title="Delete">üóëÔ∏è</div>`;
            }

            msgDiv.innerHTML = `
                <div class="avatar">${msg.username[0].toUpperCase()}</div>
                <div class="message-content">
                    <h4>${msg.username} ${badgeHtml} <span class="timestamp">${time}</span></h4>
                    <p class="text">${msg.content}</p>
                </div>
                <div class="message-actions">
                    ${deleteBtn}
                </div>
            `;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        // --- 5. SEND & COMMANDS ---
        input.addEventListener('keydown', async function (e) {
            if (e.key === 'Enter' && input.value.trim() !== "") {
                const text = input.value;
                input.value = "";

                // --- COMMAND PARSING (Admin Only) ---
                if (text.startsWith('/') && currentUser.email === ADMIN_EMAIL) {
                    handleCommand(text);
                    return;
                }

                // Normal Message
                await _supabase.from('messages').insert([{ 
                    username: userProfile.username, 
                    content: text, 
                    channel: currentChannel,
                    user_id: currentUser.id
                }]);
                fetchMessages(currentChannel);
            }
        });

        // --- 6. ADMIN COMMAND LOGIC ---
        async function handleCommand(cmd) {
            const parts = cmd.split(' ');
            const action = parts[0];
            const targetName = parts[1]; // Username to target
            
            const log = (msg) => {
                container.innerHTML += `<div style="padding:10px; color:#faa61a;"><i>ü§ñ SYSTEM: ${msg}</i></div>`;
                container.scrollTop = container.scrollHeight;
            };

            if (action === '/ban') {
                if (!targetName) return log("Usage: /ban [username]");
                const { data: target } = await _supabase.from('profiles').select('*').eq('username', targetName).single();
                if (target) {
                    await _supabase.from('profiles').update({ is_banned: true }).eq('id', target.id);
                    log(`üî® Banned user: ${targetName}`);
                } else {
                    log(`User ${targetName} not found.`);
                }
            } 
            else if (action === '/unban') {
                const { data: target } = await _supabase.from('profiles').select('*').eq('username', targetName).single();
                if (target) {
                    await _supabase.from('profiles').update({ is_banned: false }).eq('id', target.id);
                    log(`üòá Unbanned user: ${targetName}`);
                }
            }
            else if (action === '/purge') {
                container.innerHTML = '';
                log("Chat cleared locally.");
            }
            else {
                log("Unknown command.");
            }
        }

        // --- 7. DELETE ---
        async function deleteMessage(id) {
            if(confirm("Delete message?")) {
                const { error } = await _supabase.from('messages').delete().eq('id', id);
                if (!error) {
                    const el = document.getElementById(`msg-${id}`);
                    if(el) el.remove();
                } else {
                    console.error(error);
                    alert("Error: Database permission denied. (Old messages cannot be deleted)");
                }
            }
        }

        // Channel Switch
        document.querySelectorAll('.channel').forEach(el => {
            el.addEventListener('click', function() {
                document.querySelectorAll('.channel').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                currentChannel = this.innerText.replace('#','').trim();
                document.getElementById('current-channel-name').innerText = currentChannel;
                fetchMessages(currentChannel);
            });
        });
    </script>
</body>
</html>
