<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RealmChat | Pro</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- COPY YOUR PREVIOUS CSS HERE (Server Bar, Sidebar, etc) --- */
        /* I will include the new specific styles for the features below */
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { display: flex; height: 100vh; background-color: #36393f; color: white; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        
        /* Layout Styles (Same as before) */
        .server-bar { width: 72px; background-color: #202225; display: flex; flex-direction: column; align-items: center; padding-top: 12px; flex-shrink: 0; }
        .server-icon { width: 48px; height: 48px; background-color: #36393f; border-radius: 50%; margin-bottom: 10px; cursor: pointer; background-size: cover; position: relative; transition: 0.2s; }
        .server-icon:hover { border-radius: 15px; background-color: #5865F2; }
        .sidebar { width: 240px; background-color: #2f3136; display: flex; flex-direction: column; flex-shrink: 0; }
        .server-header { height: 48px; padding: 12px 16px; font-weight: bold; box-shadow: 0 1px 0 rgba(4,4,5,0.2); display: flex; align-items: center; }
        .channel-list { padding: 10px; flex: 1; overflow-y: auto; }
        .channel { padding: 6px 8px; margin-bottom: 2px; border-radius: 4px; color: #8e9297; cursor: pointer; display: flex; align-items: center; }
        .channel:hover { background-color: #34373c; color: #dcddde; }
        .channel.active { background-color: #393c43; color: white; }
        .chat-area { flex: 1; background-color: #36393f; display: flex; flex-direction: column; min-width: 0; }
        .chat-header { height: 48px; padding: 0 16px; display: flex; align-items: center; box-shadow: 0 1px 0 rgba(4,4,5,0.2); font-weight: bold; }
        
        /* --- NEW FEATURE STYLES --- */
        
        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        /* Message Group */
        .message { 
            display: flex; gap: 16px; padding: 5px 0; position: relative; 
        }
        .message:hover { background-color: #32353b; } /* Highlight on hover */
        
        /* Action Buttons (Delete, Reply) - Hidden until hover */
        .message-actions {
            position: absolute; right: 10px; top: -10px;
            background-color: #36393f; border: 1px solid #202225;
            border-radius: 4px; padding: 2px;
            display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .message:hover .message-actions { display: flex; }
        
        .action-btn {
            padding: 5px 8px; cursor: pointer; color: #b9bbbe; transition: 0.2s;
        }
        .action-btn:hover { color: white; background-color: #40444b; }
        .action-btn.delete:hover { color: #ed4245; }

        .avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #5865F2; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .message-content h4 { font-size: 16px; margin-bottom: 4px; color: white; font-weight: 500; }
        .timestamp { font-size: 12px; color: #72767d; font-weight: normal; margin-left: 5px; }
        .text { color: #dcddde; font-weight: 300; line-height: 1.4; white-space: pre-wrap; }
        
        /* Reply Styles */
        .reply-preview {
            font-size: 12px; color: #b9bbbe; display: flex; align-items: center; gap: 5px; margin-bottom: 4px;
        }
        .reply-line { width: 30px; height: 2px; background-color: #4f545c; border-top-left-radius: 4px; }

        .input-area { padding: 0 16px 24px; background-color: #36393f; margin-top: auto; }
        .input-box { background-color: #40444b; border-radius: 8px; padding: 11px 16px; color: white; display: flex; align-items: center; }
        input { background: transparent; border: none; color: white; width: 100%; outline: none; }

        /* Settings Modal */
        #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #36393f; padding: 30px; border-radius: 8px; width: 400px; text-align: center;
        }
        .btn-save { background-color: #3ba55c; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 15px; }
    </style>
</head>
<body>

    <div id="settings-modal">
        <div class="modal-content">
            <h2>User Profile</h2>
            <p style="color: #b9bbbe; margin: 10px 0;">Customize how you appear to others.</p>
            <input type="text" id="new-username" placeholder="Enter new display name" style="width: 100%; padding: 10px; background: #202225; border: none; color: white;">
            <button class="btn-save" onclick="saveProfile()">Save Changes</button>
            <button onclick="closeSettings()" style="background: transparent; border: none; color: #ed4245; margin-top: 10px; cursor: pointer;">Cancel</button>
        </div>
    </div>

    <div class="server-bar">
        <a href="index.html" class="server-icon" style="background-image: url('https://i.ibb.co/vC1NGG8R/fedora-realmos-start-logo.png');"></a>
    </div>

    <div class="sidebar">
        <div class="server-header">RealmOS Official üõ°Ô∏è</div>
        <div class="channel-list">
            <div class="channel active"><span style="margin-right:5px">#</span> general</div>
            <div class="channel"><span style="margin-right:5px">#</span> development</div>
            <div class="channel"><span style="margin-right:5px">#</span> off-topic</div>
        </div>
        <div style="background-color: #292b2f; padding: 8px; display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <div class="avatar" style="width: 32px; height: 32px; font-size: 12px;">U</div>
                <div><div style="font-size: 13px; font-weight: bold;" id="my-username">Loading...</div></div>
            </div>
            <div style="color: #b9bbbe; cursor: pointer;" onclick="openSettings()">‚öôÔ∏è</div>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <span style="font-size: 24px; margin-right: 10px; color: #72767d;">#</span>
            <span id="current-channel-name">general</span>
        </div>
        <div class="messages" id="message-container"></div>
        <div class="input-area">
            <div id="reply-bar" style="display: none; color: #b9bbbe; padding: 5px; font-size: 12px;">
                Replying to <b id="reply-user">User</b> <span onclick="cancelReply()" style="cursor: pointer; color: #ed4245; margin-left: 10px;">(Cancel)</span>
            </div>
            <div class="input-box">
                <input type="text" id="chat-input" placeholder="Message #general" autocomplete="off">
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const SUPABASE_URL = 'https://vmrqbonwwnpjibynevpr.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_BCCcap8OUfF3SwGxOnkVCQ_FFWeWeDR'; // YOUR KEY
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Global Variables
        let currentUser = null;
        let currentChannel = 'general';
        let replyingTo = null; // Stores the message ID we are replying to

        // DOM Elements
        const container = document.getElementById('message-container');
        const input = document.getElementById('chat-input');
        const replyBar = document.getElementById('reply-bar');

        // --- 2. AUTH & PROFILE ---
        async function checkUser() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) { window.location.href = "login.html"; return; }
            
            currentUser = user;
            
            // Get Display Name from Metadata (or default to email)
            const displayName = user.user_metadata.display_name || user.email.split('@')[0];
            document.getElementById('my-username').innerText = displayName;
            
            fetchMessages(currentChannel);
        }
        checkUser();

        // Save New Name
        async function saveProfile() {
            const newName = document.getElementById('new-username').value;
            if(!newName) return;

            // Update Supabase Auth Metadata
            const { error } = await _supabase.auth.updateUser({
                data: { display_name: newName }
            });

            if(!error) {
                document.getElementById('my-username').innerText = newName;
                closeSettings();
                alert("Name updated! (Old messages won't change, only new ones)");
            }
        }

        // --- 3. FETCH MESSAGES ---
        async function fetchMessages(channelName) {
            container.innerHTML = `<div style="padding: 20px;">Loading...</div>`;
            
            // Subscribe to Realtime Deletes/Inserts (Advanced Phase)
            // For now, standard fetch
            let { data: messages, error } = await _supabase
                .from('messages')
                .select('*')
                .eq('channel', channelName)
                .order('created_at', { ascending: true });

            container.innerHTML = "";
            if(messages) {
                messages.forEach(msg => renderMessage(msg));
            }
        }

        // --- 4. RENDER MESSAGE (With Delete & Reply) ---
        function renderMessage(msg) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message';
            msgDiv.id = `msg-${msg.id}`; // Give div an ID to find it later

            const time = new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // DELETE BUTTON LOGIC: Only show if I own the message
            let deleteBtn = '';
            // Note: We check if msg.user_id matches my ID
            if (currentUser && msg.user_id === currentUser.id) {
                deleteBtn = `<div class="action-btn delete" onclick="deleteMessage('${msg.id}')" title="Delete">üóëÔ∏è</div>`;
            }

            // REPLY HTML (If this message IS a reply)
            let replyHtml = '';
            if(msg.reply_to) {
                replyHtml = `<div class="reply-preview"><i class="fas fa-reply"></i> Replying to a message</div>`;
            }

            msgDiv.innerHTML = `
                <div class="avatar">${msg.username[0].toUpperCase()}</div>
                <div class="message-content">
                    ${replyHtml}
                    <h4>${msg.username} <span class="timestamp">${time}</span></h4>
                    <p class="text">${msg.content}</p>
                </div>
                
                <div class="message-actions">
                    <div class="action-btn" onclick="startReply('${msg.username}', '${msg.content}')" title="Reply">‚Ü©Ô∏è</div>
                    ${deleteBtn}
                </div>
            `;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        // --- 5. SEND MESSAGE ---
        input.addEventListener('keydown', async function (e) {
            if (e.key === 'Enter' && input.value.trim() !== "") {
                const text = input.value;
                input.value = "";
                
                // Get current display name
                const displayName = document.getElementById('my-username').innerText;

                // Send to DB
                await _supabase.from('messages').insert([{ 
                    username: displayName, 
                    content: text, 
                    channel: currentChannel,
                    user_id: currentUser.id, // SAVE USER ID FOR DELETION
                    reply_to: replyingTo // SAVE REPLY INFO
                }]);

                cancelReply(); // Reset reply mode
                fetchMessages(currentChannel); // Refresh to see new msg
            }
        });

        // --- 6. DELETE LOGIC ---
        async function deleteMessage(id) {
            if(confirm("Delete this message?")) {
                const { error } = await _supabase.from('messages').delete().eq('id', id);
                if(!error) {
                    // Remove from screen immediately
                    const div = document.getElementById(`msg-${id}`);
                    if(div) div.remove();
                }
            }
        }

        // --- 7. REPLY LOGIC ---
        function startReply(user, text) {
            replyingTo = text; // Ideally store ID, but storing text is simpler for display
            replyBar.style.display = 'block';
            document.getElementById('reply-user').innerText = user;
            input.focus();
        }

        function cancelReply() {
            replyingTo = null;
            replyBar.style.display = 'none';
        }

        // --- 8. SETTINGS UI ---
        function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
        
        // Channel Switching
        document.querySelectorAll('.channel').forEach(el => {
            el.addEventListener('click', function() {
                document.querySelectorAll('.channel').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                currentChannel = this.innerText.replace('#','').trim();
                document.getElementById('current-channel-name').innerText = currentChannel;
                fetchMessages(currentChannel);
            });
        });

    </script>
</body>
</html>
