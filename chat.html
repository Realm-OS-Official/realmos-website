<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RealmChat | Universe</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- STYLES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { display: flex; height: 100vh; background-color: #36393f; color: white; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        
        /* Layout */
        .server-bar { width: 72px; background-color: #202225; display: flex; flex-direction: column; align-items: center; padding-top: 12px; flex-shrink: 0; }
        .server-icon { width: 48px; height: 48px; background-color: #36393f; border-radius: 50%; margin-bottom: 10px; cursor: pointer; background-size: cover; position: relative; transition: 0.2s; }
        .server-icon:hover { border-radius: 15px; background-color: #5865F2; }
        
        .sidebar { width: 240px; background-color: #2f3136; display: flex; flex-direction: column; flex-shrink: 0; }
        .server-header { height: 48px; padding: 12px 16px; font-weight: bold; box-shadow: 0 1px 0 rgba(4,4,5,0.2); display: flex; align-items: center; justify-content: space-between; }
        .channel-list { padding: 10px; flex: 1; overflow-y: auto; }
        .channel { padding: 6px 8px; margin-bottom: 2px; border-radius: 4px; color: #8e9297; cursor: pointer; display: flex; align-items: center; }
        .channel:hover { background-color: #34373c; color: #dcddde; }
        .channel.active { background-color: #393c43; color: white; }
        
        .chat-area { flex: 1; background-color: #36393f; display: flex; flex-direction: column; min-width: 0; }
        .chat-header { height: 48px; padding: 0 16px; display: flex; align-items: center; box-shadow: 0 1px 0 rgba(4,4,5,0.2); font-weight: bold; justify-content: space-between;}
        
        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        /* Message Styles */
        .message { display: flex; gap: 16px; padding: 5px 0; position: relative; border-left: 3px solid transparent; padding-left: 8px; }
        .message:hover { background-color: #32353b; }
        .message.pinned { background-color: rgba(250, 166, 26, 0.1); border-left: 3px solid #faa61a; }
        
        .message-actions { position: absolute; right: 10px; top: -10px; background-color: #36393f; border: 1px solid #202225; border-radius: 4px; padding: 2px; display: none; }
        .message:hover .message-actions { display: flex; }
        .action-btn { padding: 5px 8px; cursor: pointer; color: #b9bbbe; }
        .action-btn:hover { color: white; background-color: #40444b; }
        .action-btn.delete:hover { color: #ed4245; }
        .action-btn.pin:hover { color: #faa61a; }

        .avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #5865F2; flex-shrink: 0; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .message-content h4 { font-size: 16px; margin-bottom: 4px; color: white; font-weight: 500; }
        
        /* Images in Chat */
        .chat-image { max-width: 300px; max-height: 200px; border-radius: 8px; margin-top: 5px; cursor: pointer; }
        
        /* Badges */
        .badge { font-size: 10px; padding: 2px 4px; border-radius: 3px; vertical-align: middle; margin-left: 5px; }
        .badge-admin { background-color: #ed4245; color: white; }
        .badge-mod { background-color: #faa61a; color: black; }

        .input-area { padding: 0 16px 24px; background-color: #36393f; margin-top: auto; }
        .input-box { background-color: #40444b; border-radius: 8px; padding: 11px 16px; color: white; display: flex; align-items: center; }
        input { background: transparent; border: none; color: white; width: 100%; outline: none; }

        /* Stats & Modal */
        .stats-box { font-size: 12px; color: #b9bbbe; padding: 10px; border-top: 1px solid #202225; }
        
        #settings-modal, #image-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content { background-color: #36393f; padding: 30px; border-radius: 8px; width: 400px; text-align: center; }
        .btn-save { background-color: #3ba55c; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 15px; }
        .input-field { width: 100%; padding: 10px; background: #202225; border: none; color: white; margin-top: 10px; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="settings-modal">
        <div class="modal-content">
            <h2>User Profile</h2>
            <p style="color: #b9bbbe;">Customize your identity.</p>
            <input type="text" id="new-username" class="input-field" placeholder="Display Name">
            <input type="text" id="new-avatar" class="input-field" placeholder="Avatar URL (Image Link)">
            <button class="btn-save" onclick="saveProfile()">Save Changes</button>
            <button onclick="closeSettings()" style="background: transparent; border: none; color: #ed4245; margin-top: 10px; cursor: pointer;">Cancel</button>
        </div>
    </div>

    <div id="image-modal">
        <div class="modal-content">
            <h2>Send Image / GIF</h2>
            <p style="color: #b9bbbe;">Paste a direct link to an image.</p>
            <input type="text" id="img-url-input" class="input-field" placeholder="https://example.com/image.png">
            <button class="btn-save" onclick="sendImage()">Send</button>
            <button onclick="closeImageModal()" style="background: transparent; border: none; color: #ed4245; margin-top: 10px; cursor: pointer;">Cancel</button>
        </div>
    </div>

    <div class="server-bar">
        <a href="index.html" class="server-icon" style="background-image: url('https://i.ibb.co/vC1NGG8R/fedora-realmos-start-logo.png');"></a>
    </div>

    <div class="sidebar">
        <div class="server-header">RealmOS <span id="admin-indicator" style="display:none; color: #ed4245; font-size: 10px; margin-left: 5px;">ADMIN</span></div>
        <div class="channel-list">
            <div class="channel active"><span style="margin-right:5px">#</span> general</div>
            <div class="channel"><span style="margin-right:5px">#</span> development</div>
            <div class="channel"><span style="margin-right:5px">#</span> realm-submissions</div>
        </div>
        
        <div class="stats-box">
            <div id="member-count">üü¢ Loading...</div>
        </div>

        <div style="background-color: #292b2f; padding: 8px; display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <div class="avatar" id="my-avatar-display" style="width: 32px; height: 32px; font-size: 12px;">U</div>
                <div><div style="font-size: 13px; font-weight: bold;" id="my-username">Loading...</div></div>
            </div>
            <div style="color: #b9bbbe; cursor: pointer;" onclick="openSettings()">‚öôÔ∏è</div>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <span style="font-size: 24px; margin-right: 10px; color: #72767d;">#</span>
            <span id="current-channel-name">general</span>
        </div>
        <div class="messages" id="message-container"></div>
        <div class="input-area">
            <div class="input-box">
                <div onclick="openImageModal()" style="width: 24px; height: 24px; background-color: #b9bbbe; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold; color: #40444b; cursor: pointer;">+</div>
                <input type="text" id="chat-input" placeholder="Message #general" autocomplete="off">
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://vmrqbonwwnpjibynevpr.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_BCCcap8OUfF3SwGxOnkVCQ_FFWeWeDR';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // State
        let currentUser = null;
        let userProfile = null;
        let currentChannel = 'general';
        const ADMIN_EMAIL = 'realmos.official@outlook.com';

        // DOM
        const container = document.getElementById('message-container');
        const input = document.getElementById('chat-input');
        
        // --- 1. AUTH & PROFILES ---
        async function checkUser() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) { window.location.href = "login.html"; return; }
            currentUser = user;

            let { data: profile } = await _supabase.from('profiles').select('*').eq('id', user.id).single();
            
            if (!profile) {
                const username = user.user_metadata.display_name || user.email.split('@')[0];
                const { data: newProfile } = await _supabase.from('profiles').insert([{
                    id: user.id, email: user.email, username: username,
                    role: (user.email === ADMIN_EMAIL) ? 'admin' : 'member'
                }]).select().single();
                userProfile = newProfile;
            } else {
                userProfile = profile;
            }

            if (userProfile.is_banned) {
                document.body.innerHTML = `<h1 style="color:red; text-align:center; margin-top:50px;">üö´ BANNED</h1>`;
                return;
            }

            // Update UI
            document.getElementById('my-username').innerText = userProfile.username;
            if(userProfile.avatar_url) {
                document.getElementById('my-avatar-display').style.backgroundImage = `url('${userProfile.avatar_url}')`;
                document.getElementById('my-avatar-display').innerText = '';
            }

            if (user.email === ADMIN_EMAIL) document.getElementById('admin-indicator').style.display = 'inline';

            updateMemberCount();
            fetchMessages(currentChannel);
        }
        checkUser();

        async function updateMemberCount() {
            const { count } = await _supabase.from('profiles').select('*', { count: 'exact', head: true });
            document.getElementById('member-count').innerText = `üü¢ ${count || 1} Members`;
        }

        // --- 2. SETTINGS & IMAGE MODALS ---
        function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
        
        async function saveProfile() {
            const newName = document.getElementById('new-username').value;
            const newAvatar = document.getElementById('new-avatar').value;
            
            const updates = {};
            if(newName) updates.username = newName;
            if(newAvatar) updates.avatar_url = newAvatar;

            await _supabase.from('profiles').update(updates).eq('id', currentUser.id);
            location.reload(); // Simple reload to apply changes
        }

        function openImageModal() { document.getElementById('image-modal').style.display = 'flex'; }
        function closeImageModal() { document.getElementById('image-modal').style.display = 'none'; }

        async function sendImage() {
            const url = document.getElementById('img-url-input').value;
            if(!url) return;

            await _supabase.from('messages').insert([{ 
                username: userProfile.username, 
                content: "Sent an image", 
                image_url: url,
                channel: currentChannel,
                user_id: currentUser.id
            }]);
            closeImageModal();
            fetchMessages(currentChannel);
        }

        // --- 3. FETCH MESSAGES ---
        async function fetchMessages(channelName) {
            container.innerHTML = `<div style="padding: 20px;">Loading...</div>`;
            let { data: messages, error } = await _supabase
                .from('messages')
                .select('*')
                .eq('channel', channelName)
                .order('created_at', { ascending: true });

            container.innerHTML = "";
            if(messages) messages.forEach(renderMessage);
        }

        // --- 4. RENDER MESSAGE ---
        function renderMessage(msg) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${msg.is_pinned ? 'pinned' : ''}`;
            msgDiv.id = `msg-${msg.id}`;

            const time = new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Avatar Handling
            // In a real app we'd fetch the user's latest avatar, but for now we use initials or default
            let avatarHtml = `<div class="avatar">${msg.username[0].toUpperCase()}</div>`;

            // Admin Badge
            let badgeHtml = '';
            if (msg.username.toLowerCase().includes('admin')) badgeHtml = `<span class="badge badge-admin">ADMIN</span>`;

            // Pin Icon (if pinned)
            let pinIndicator = msg.is_pinned ? `<i class="fas fa-thumbtack" style="color:#faa61a; font-size:12px; margin-right:5px;"></i>` : '';

            // Image Content
            let contentHtml = `<p class="text">${msg.content}</p>`;
            if (msg.image_url) {
                contentHtml = `<img src="${msg.image_url}" class="chat-image" onclick="window.open(this.src)">`;
            }

            // Buttons
            let deleteBtn = '';
            if ((currentUser && msg.user_id === currentUser.id) || (currentUser.email === ADMIN_EMAIL)) {
                deleteBtn = `<div class="action-btn delete" onclick="deleteMessage('${msg.id}')" title="Delete">üóëÔ∏è</div>`;
            }
            
            // Pin Button (Admin Only)
            let pinBtn = '';
            if (currentUser && currentUser.email === ADMIN_EMAIL) {
                pinBtn = `<div class="action-btn pin" onclick="togglePin('${msg.id}', ${!msg.is_pinned})" title="Pin/Unpin">üìå</div>`;
            }

            msgDiv.innerHTML = `
                ${avatarHtml}
                <div class="message-content">
                    <h4>${pinIndicator} ${msg.username} ${badgeHtml} <span class="timestamp">${time}</span></h4>
                    ${contentHtml}
                </div>
                <div class="message-actions">
                    ${pinBtn}
                    ${deleteBtn}
                </div>
            `;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        // --- 5. SEND MESSAGE ---
        input.addEventListener('keydown', async function (e) {
            if (e.key === 'Enter' && input.value.trim() !== "") {
                const text = input.value;
                input.value = "";

                // Commands
                if (text.startsWith('/') && currentUser.email === ADMIN_EMAIL) {
                    handleCommand(text);
                    return;
                }

                await _supabase.from('messages').insert([{ 
                    username: userProfile.username, 
                    content: text, 
                    channel: currentChannel,
                    user_id: currentUser.id
                }]);
                fetchMessages(currentChannel);
            }
        });

        // --- 6. ACTIONS ---
        async function deleteMessage(id) {
            if(confirm("Delete message?")) {
                await _supabase.from('messages').delete().eq('id', id);
                document.getElementById(`msg-${id}`).remove();
            }
        }

        async function togglePin(id, newState) {
            await _supabase.from('messages').update({ is_pinned: newState }).eq('id', id);
            fetchMessages(currentChannel); // Reload to show change
        }

        // Commands (Simplified for brevity)
        async function handleCommand(cmd) {
            const parts = cmd.split(' ');
            if (parts[0] === '/purge') { container.innerHTML = ''; }
        }

        // Channel Switch
        document.querySelectorAll('.channel').forEach(el => {
            el.addEventListener('click', function() {
                document.querySelectorAll('.channel').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                currentChannel = this.innerText.replace('#','').trim();
                document.getElementById('current-channel-name').innerText = currentChannel;
                fetchMessages(currentChannel);
            });
        });
    </script>
</body>
</html>
